#tag ClassProtected Class NSDistributedNotificationsObserverInherits CocoaDelegate	#tag Event		Function DelegateClassName() As String		  		  return "MLNSDistributedNotificationsObserver"		  		End Function	#tag EndEvent	#tag Event		Function DelegateMethods() As Tuple()		  		  dim methodList() as Tuple		  methodList.Append kNotificationSelector : FPtr(AddressOf DispatchNotification) : "v@:@"		  		  return methodList		  		End Function	#tag EndEvent	#tag Method, Flags = &h1000		Sub Constructor(handler as NSDistributedNotificationsInterface = nil)		  		  // construct a delegate and accept an optional delegate handler which is a NSDistributedNotificationsInterface instance		  // this permits to use this class in two modes:		  //		  // 1. Without subclassing, just instantiating it passing a NSDistributedNotificationsInterface member that will handle		  //     the events (eg. a window or another class). The handler can also be changed at any time setting the DelegateHandler		  //     property.		  //		  // 2. Subclassing this class and handling the events. This can be also done dragging an instance of this class in a window.		  //		  		  // store the handler		  DelegateHandler = handler		  		  // call super to construct the object		  super.Constructor		  		  // raise the Open event (for use by subclasses or instances dragged to a window)		  raiseEvent Open()		  		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Destructor()		  		  // if we are registered as observer, we must unregister before getting deallocated or a runtime error will happen		  if registered then		    self.Unregister		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h21		Private Shared Sub DispatchNotification(id as Ptr, sel as Ptr, notification as Ptr)		  		  // dispatch the message to the right instance handler		  		  #pragma StackOverflowChecking false		  		  #pragma unused sel		  		  if CocoaDelegateMap.HasKey(id) then // lookup the delegate instance		    dim w as WeakRef = CocoaDelegateMap.Lookup(id, new WeakRef(nil))		    dim obj as NSDistributedNotificationsObserver = NSDistributedNotificationsObserver(w.Value) // get the delegate instance		    		    // be sure to have a valid object		    if obj = nil then		      return		    end if		    		    // build objects to pass to the instance method		    dim notificationObj as NSNotification		    if notification <> nil then		      notificationObj = new NSNotification(notification)		      		      obj.NotificationHandler notificationObj		      		    end if		    		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h21		Private Sub NotificationHandler(notification as NSNotification)		  		  // handle the message and call the handler or fire the event		  		  if DelegateHandler <> nil then		    DelegateHandler.NotificationReceived(notification)		  else		    raiseEvent NotificationReceived(notification)		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Register()		  		  // These notifications are accessible through the shared distributed notification center		  		  // only proceed if we are not already registered		  if not registered then		    // get the distributed notification center		    dim center as NSDistributedNotificationCenter = NSDistributedNotificationCenter.DefaultCenter		    		    // registering for all distributed notifications		    center.AddObserver self, kNotificationSelector, "", nil		    		    // mark we registered as observer		    registered = true		  end if		  		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Unregister()		  		  // These notifications are accessible through the shared default notification center		  		  // only proceed if we are currently registered		  if registered then		    // get the notification center		    dim center as NSDistributedNotificationCenter = NSDistributedNotificationCenter.DefaultCenter		    		    // unregister self as observer		    center.RemoveObserver self		    		    // mark we are no longer registered as observer		    registered = false		  end if		End Sub	#tag EndMethod	#tag Hook, Flags = &h0		Event NotificationReceived(notification as NSNotification)	#tag EndHook	#tag Hook, Flags = &h0		Event Open()	#tag EndHook	#tag Property, Flags = &h0		DelegateHandler As NSDistributedNotificationsInterface	#tag EndProperty	#tag Property, Flags = &h21		Private registered As Boolean	#tag EndProperty	#tag Constant, Name = kNotificationSelector, Type = String, Dynamic = False, Default = \"dispatchDistributedNotification:", Scope = Private	#tag EndConstant	#tag ViewBehavior		#tag ViewProperty			Name="ClassName"			Group="Behavior"			Type="String"			EditorType="MultiLineEditor"			InheritedFrom="CocoaDelegate"		#tag EndViewProperty		#tag ViewProperty			Name="Description"			Group="Behavior"			Type="String"			EditorType="MultiLineEditor"			InheritedFrom="NSObject"		#tag EndViewProperty		#tag ViewProperty			Name="Index"			Visible=true			Group="ID"			InitialValue="-2147483648"			Type="Integer"			InheritedFrom="Object"		#tag EndViewProperty		#tag ViewProperty			Name="Left"			Visible=true			Group="Position"			InitialValue="0"			InheritedFrom="Object"		#tag EndViewProperty		#tag ViewProperty			Name="Name"			Visible=true			Group="ID"			InheritedFrom="Object"		#tag EndViewProperty		#tag ViewProperty			Name="Super"			Visible=true			Group="ID"			InheritedFrom="Object"		#tag EndViewProperty		#tag ViewProperty			Name="Top"			Visible=true			Group="Position"			InitialValue="0"			InheritedFrom="Object"		#tag EndViewProperty	#tag EndViewBehaviorEnd Class#tag EndClass