#tag WindowBegin Window wndSearchMovies   BackColor       =   &hFFFFFF   Backdrop        =   ""   CloseButton     =   True   Composite       =   False   Frame           =   1   FullScreen      =   False   HasBackColor    =   False   Height          =   500   ImplicitInstance=   True   LiveResize      =   False   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   ""   MenuBarVisible  =   True   MinHeight       =   64   MinimizeButton  =   False   MinWidth        =   64   Placement       =   3   Resizeable      =   False   Title           =   "#wTitle"   Visible         =   True   Width           =   800   Begin ListboxPRO lstResults      AlternatingRows =   True      AutoDeactivate  =   True      AutoHideScrollbars=   True      Bold            =   ""      Border          =   True      ColumnCount     =   10      ColumnsResizable=   False      ColumnWidths    =   "100%"      DataField       =   ""      DataSource      =   ""      DefaultRowHeight=   22      Enabled         =   True      EnableDrag      =   ""      EnableDragReorder=   ""      GridLinesHorizontal=   0      GridLinesVertical=   0      HasHeading      =   False      HeadingIndex    =   -1      Height          =   413      HelpTag         =   ""      Hierarchical    =   False      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   ""      Italic          =   ""      Left            =   0      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      RequiresSelection=   True      Scope           =   0      ScrollbarHorizontal=   ""      ScrollBarVertical=   True      SelectionGradient=   True      SelectionType   =   0      SourceList      =   False      TabIndex        =   1      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   12      TextUnit        =   0      Top             =   33      TypeToSearch    =   False      Underline       =   ""      UseFocusRing    =   False      Visible         =   True      Width           =   300      _ScrollWidth    =   -1   End   Begin ccSearch ccSearchMovies      AcceptFocus     =   ""      AcceptTabs      =   True      AutoDeactivate  =   True      BackColor       =   16777215      Backdrop        =   ""      Enabled         =   True      EraseBackground =   True      HasBackColor    =   False      Height          =   33      HelpTag         =   "#kUseIMDBID"      InitialParent   =   ""      Left            =   0      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   True      LockRight       =   False      LockTop         =   True      Scope           =   0      TabIndex        =   0      TabPanelIndex   =   0      TabStop         =   True      Top             =   0      UseFocusRing    =   False      Visible         =   True      Width           =   300   End   Begin ccCancelSave CancelSave      AcceptFocus     =   ""      AcceptTabs      =   True      AutoDeactivate  =   True      BackColor       =   &hFFFFFF      Backdrop        =   ""      Enabled         =   True      EraseBackground =   True      HasBackColor    =   False      Height          =   22      HelpTag         =   ""      InitialParent   =   ""      Left            =   608      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   False      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      Top             =   458      UseFocusRing    =   ""      Visible         =   True      Width           =   172   End   Begin Canvas cvsInfo      AcceptFocus     =   ""      AcceptTabs      =   ""      AutoDeactivate  =   True      Backdrop        =   ""      DoubleBuffer    =   False      Enabled         =   True      EraseBackground =   True      Height          =   446      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   300      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      Scope           =   0      TabIndex        =   3      TabPanelIndex   =   0      TabStop         =   True      Top             =   0      UseFocusRing    =   True      Visible         =   True      Width           =   500   End   Begin MovieSckt scktTMDB      Address         =   ""      Height          =   32      Index           =   -2147483648      InitialParent   =   ""      Left            =   20      LockedInPosition=   False      Port            =   0      Scope           =   0      TabPanelIndex   =   0      Top             =   512      Width           =   32      yield           =   0   End   Begin ProgressWheel prgWheel      AutoDeactivate  =   True      Enabled         =   True      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   574      LockBottom      =   ""      LockedInPosition=   False      LockLeft        =   True      LockRight       =   ""      LockTop         =   True      Scope           =   0      TabIndex        =   4      TabPanelIndex   =   0      TabStop         =   True      Top             =   458      Visible         =   False      Width           =   22   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Close()		  scktTMDB.Close		End Sub	#tag EndEvent	#tag MenuHandler		Function FileCloseWindow() As Boolean Handles FileCloseWindow.Action			Close			Return True					End Function	#tag EndMenuHandler	#tag Method, Flags = &h0		Sub QuickDecode(JSONString as String)		  scktTMDB.Yield = True		  		  // pFanart = Nil		  // pPoster = Nil		  		  If NOT JSONString.ValidJSON("TMDB-Search") Then Return		  Dim JSON as New JSONItem		  JSON.Load JSONString		  		  pPlot     = JSON.Value("overview")		  pTagline  = JSON.Value("tagline")		  pDuration = JSON.Value("runtime")		  pPremiere = JSON.Value("release_date")		  pIMDBID   = JSON.Value("imdb_id")		  		  For i as Integer = 0 To JSON.Child("genres").Count - 1		    If i = JSON.Child("genres").Count -1 Then		      pGenres = pGenres + JSON.Child("genres").Child(i).Value("name")		    Else		      pGenres = pGenres + JSON.Child("genres").Child(i).Value("name") + ", "		    End If		  Next		End Sub	#tag EndMethod	#tag Property, Flags = &h0		LastIndex As Integer = -1	#tag EndProperty	#tag Property, Flags = &h0		pDuration As String	#tag EndProperty	#tag Property, Flags = &h0		pFanart As Picture	#tag EndProperty	#tag Property, Flags = &h0		pGenres As String	#tag EndProperty	#tag Property, Flags = &h0		pIMDBID As String	#tag EndProperty	#tag Property, Flags = &h0		pPlot As String	#tag EndProperty	#tag Property, Flags = &h0		pPoster As Picture	#tag EndProperty	#tag Property, Flags = &h0		pPremiere As String	#tag EndProperty	#tag Property, Flags = &h0		pTagline As String	#tag EndProperty	#tag Constant, Name = kSearchFieldHelpText, Type = String, Dynamic = True, Default = \"Movie title (year) or IMDb ID", Scope = Protected		#Tag Instance, Platform = Any, Language = en, Definition  = \"Movie title (year) or IMDb ID"		#Tag Instance, Platform = Any, Language = nl, Definition  = \"Film titel (jaar) of IMDb ID"	#tag EndConstant	#tag Constant, Name = kUseIMDBID, Type = String, Dynamic = True, Default = \"Instead of key words\x2C you can also use an IMDb ID to search for a movie.", Scope = Protected		#Tag Instance, Platform = Any, Language = en, Definition  = \"Instead of key words\x2C you can also use an IMDb ID to search for a movie."		#Tag Instance, Platform = Any, Language = nl, Definition  = \"In plaats van sleutelwoorden\x2C kunt u ook een IMDb ID gebruiken om te zoeken naar een film."	#tag EndConstant	#tag Constant, Name = wTitle, Type = String, Dynamic = True, Default = \"Search Movies", Scope = Protected		#Tag Instance, Platform = Any, Language = en, Definition  = \"Search Movies"		#Tag Instance, Platform = Any, Language = nl, Definition  = \"Zoek Films"	#tag EndConstant#tag EndWindowCode#tag Events lstResults	#tag Event		Function KeyDown(Key As String) As Boolean		  If Keyboard.AsyncKeyDown( &h4C ) or Keyboard.AsyncKeyDown( &h24 ) then // Pressed Enter		    If Me.ListIndex > -1 then CancelSave.btnRight.Push		  ElseIf Keyboard.AsyncKeyDown( &h35 ) then // Pressed Escape		    CancelSave.btnLeft.Push		  End If		End Function	#tag EndEvent	#tag Event		Sub DoubleClick()		  If Me.ListIndex > -1 Then CancelSave.btnRight.Push		End Sub	#tag EndEvent	#tag Event		Sub Change()		  scktTMDB.Yield = True		  		  If Me.ListIndex = -1 Then Return		  		  If LastIndex = me.ListIndex Then Return		  		  scktTMDB.Disconnect		  scktTMDB.Close		  scktTMDB.Flush		  		  prgWheel.Visible = True		  		  pPoster = Nil		  pFanart = Nil		  		  pPlot    = ""		  pGenres  = ""		  pTagline = ""		  pIMDBID  = ""		  pDuration = ""		  pPremiere = ""		  		  cvsInfo.Refresh		  		  		  // ---- Load Info		  Dim JSONString as String		  		  If lstResults.Cell( lstResults.ListIndex, 7 ) <> "" Then JSONString = lstResults.Cell( lstResults.ListIndex, 7 )		  		  If JSONString = "" And lstResults.Cell( lstResults.ListIndex, 1 ) <> "" Then		    JSONString = DefineEncoding( scktTMDB.Get( scktTMDB.URL( "MovieInfo", lstResults.Cell( lstResults.ListIndex, 1 ), Prefs.textStringForKey("DBLanguage") ), Prefs.integerForKey("TimeOut" ) ), Encodings.UTF8 )		    'If JSONString.ValidJSON Then lstResults.Cell( lstResults.ListIndex, 7 ) = JSONString		  End If		  		  QuickDecode ConvertEncoding( JSONString, Encodings.UTF8 )		  		  cvsInfo.Refresh		  		  // ---- Load Images		  		  // Poster		  If lstResults.Cell( lstResults.ListIndex, 4 ) <> "" Then		    pPoster = Picture.FromData( scktTMDB.Get( lstResults.Cell( lstResults.ListIndex, 4 ), 0 ) )		    scktTMDB.Close		  End If		  		  // Fanart		  If lstResults.Cell( lstResults.ListIndex, 5 ) <> "" Then		    pFanart = Picture.FromData( scktTMDB.Get( lstResults.Cell( lstResults.ListIndex, 5 ), 0 ) )		    scktTMDB.Close		  End If		  		  		  cvsInfo.Refresh		  		  prgWheel.Visible = False		  		  LastIndex = Me.ListIndex		End Sub	#tag EndEvent#tag EndEvents#tag Events ccSearchMovies	#tag Event		Sub DoSearch(SearchText as String)		  If Trim(SearchText) = "" Then Return		  LastIndex = -1		  		  If SearchText.Left(2) = "tt" Or ( SearchText.InStr(0, " ") = 0 And Val(SearchText) > 0 ) Then		    Self.Close		    dlgProgress.ScrapeMovie( SearchText, lstResults.Cell( lstResults.ListIndex, 0 ) )		  Else		    'dlgProgress.Start( Loc.kSearching + ":", SearchText, 0, "SelectedMovie" )		    MovieCore.MovieSearch( SearchText, True )		  End If		End Sub	#tag EndEvent	#tag Event		Function KeyDown(Key As String) As Boolean		  If Asc(Key) = 13 Then Return True		End Function	#tag EndEvent	#tag Event		Sub ResetSearch()		  Me.edtSearch.Text = ""		End Sub	#tag EndEvent	#tag Event		Sub Open()		  Me.edtSearch.CueText = kSearchFieldHelpText		End Sub	#tag EndEvent#tag EndEvents#tag Events CancelSave	#tag Event		Sub ActionCancel()		  dlgProgress.Close		  Close		End Sub	#tag EndEvent	#tag Event		Sub ActionOK()		  // TO DO		  		  Dim ID as String   = lstResults.Cell( lstResults.ListIndex, 1 )		  Dim Name as String = lstResults.Cell( lstResults.ListIndex, 0 )		  dlgProgress.Close		  Close		  dlgProgress.ScrapeMovie( ID, Name )		End Sub	#tag EndEvent#tag EndEvents#tag Events cvsInfo	#tag Event		Sub Paint(g As Graphics)		  Dim Textleft, TextTop, ParamLeft as Integer		  		  // Fill BG		  g.ForeColor = RGB(255, 255, 255)		  g.FillRect 0, 0, Me.Width, Me.Height		  		  // Fanart		  If pFanart <> Nil Then		    Dim PicFanart as Picture		    PicFanart = ScaleImage( pFanart, Me.Width, Me.Height, True, True, False )		    PicFanart.Graphics.DrawPicture IMGFanartOverlay, 0, 0, PicFanart.Width, PicFanart.Height,    0, 0, IMGFanartOverlay.Width, IMGFanartOverlay.Height		    Graphics.DrawPicture PicFanart, Me.Left, Me.Top		  End If		  		  // Poster		  If pPoster <> Nil Then		    Dim PicPoster as New Picture( 154, 231, 32 )		    		    PicPoster.Graphics.DrawPicture( pPoster,        2, 1, 150, 225,   0, 0, pPoster.Width, pPoster.Height )		    PicPoster.Graphics.DrawPicture( PosterOverlay, 0, 0, PicPoster.Width, PicPoster.Height )		    PicPoster.Mask = PosterMask		    		    'Dim w as Integer = pPoster.Height / pPoster.Width		    'g.DrawPicture ScaleImage( PicPoster, ( ( pPoster.Width * w ) / pPoster.Height ) * 147, ( ( pPoster.Height * w ) / pPoster.Height ) * 147 ), 19, 15		    g.DrawPicture ScaleImage( PicPoster, 100, 147, True ), 10, 15		    		    Textleft = 10 + 100 + 10		  Else		    Textleft = 10		  End If		  		  		  // Title		  g.ForeColor = RGB(30, 30, 30)		  g.TextSize  = 16		  g.Bold      = True		  TextTop     = 12 + g.TextSize		  ParamLeft   = 220		  		  g.DrawString( lstResults.Cell( lstResults.ListIndex, 0 ), Textleft, TextTop, Me.Width - Textleft - 10, False )		  		  // Next TextTop		  g.TextSize = 12		  TextTop = TextTop + g.StringHeight( lstResults.Cell( lstResults.ListIndex, 0 ), Me.Width - Textleft - 100  ) + 3' + 10		  		  // Tagline		  If pTagline <> "" Then		    g.Bold = False		    g.Italic = True		    g.DrawString( pTagline, Textleft, TextTop, Me.Width - Textleft - 10, True )		    		    g.Italic = False		  End If		  		  // FolderPath		  TextTop = TextTop + 25		  g.Bold = True		  g.DrawString( Loc.kLocation, Textleft, TextTop )		  		  g.Bold = False		  g.DrawString( ".../" + MovieAttr.FolderParent.Parent.Name + "/" + MovieAttr.FolderParent.Name + "/", ParamLeft, TextTop, Me.Width - ParamLeft - 10, True )		  		  // Runtime		  If pDuration <> "" and Val( pDuration ) > 0 Then		    TextTop = TextTop + 16		    g.Bold = True		    g.DrawString( Loc.kRuntime + ":", Textleft, TextTop )		    		    g.Bold = False		    g.DrawString( Val( pDuration ).Minutes2Hours, ParamLeft, TextTop )		  End If		  		  // Premiered		  If pPremiere <> "" Then		    TextTop = TextTop + 16		    g.Bold = True		    g.DrawString( Loc.kPremiered, Textleft, TextTop )		    		    g.Bold = False		    g.DrawString( PrettyDate( pPremiere ), ParamLeft, TextTop )		  End If		  		  // Genres		  If pGenres <> "" Then		    g.Bold = True		    TextTop = TextTop + 16		    If pGenres.InStr(0, ",") > 0 Then		      g.DrawString( Loc.kGenres, Textleft, TextTop )		    Else		      g.DrawString( Loc.kGenre, Textleft, TextTop )		    End If		    		    g.Bold = False		    g.DrawString( pGenres, ParamLeft, TextTop, Me.Width - ParamLeft - 10, True )		  End If		  		  If pIMDBID <> "" Then		    g.Bold = True		    TextTop = TextTop + 16		    g.DrawString( "IMDb ID:", Textleft, TextTop )		    		    g.Bold = False		    g.DrawString( pIMDBID, ParamLeft, TextTop )		  End If		  		  // Plot		  If pPlot <> "" Then		    TextTop  = 168 + 10		    Textleft = 10		    g.Bold   = True		    		    g.DrawString( Loc.kPlot, Textleft, TextTop, Me.Width - 20, False )		    		    g.Bold = False		    		    // Smaller text if there's a lot of it, may still overflow though...		    If g.StringHeight( pPlot, Me.Width - 30 ) > Me.Height - TextTop Then g.TextSize = 10		    // TODO: Add scrollability?		    		    g.DrawString( pPlot, Textleft, TextTop + 16, Me.Width - 30, False )		  End If		  		  		  g.ForeColor = rgb(194, 194, 194)		  g.DrawLine 0, Me.Height - 1, Me.Width, Me.Height - 1		End Sub	#tag EndEvent#tag EndEvents