#tag WindowBegin Window wndSetManager2   BackColor       =   &hFFFFFF   Backdrop        =   ""   CloseButton     =   True   Composite       =   False   Frame           =   0   FullScreen      =   False   HasBackColor    =   False   Height          =   5.2e+2   ImplicitInstance=   True   LiveResize      =   True   MacProcID       =   0   MaxHeight       =   32000   MaximizeButton  =   False   MaxWidth        =   32000   MenuBar         =   ""   MenuBarVisible  =   True   MinHeight       =   64   MinimizeButton  =   True   MinWidth        =   64   Placement       =   3   Resizeable      =   False   Title           =   "#Localizable.MovieSetsManager"   Visible         =   True   Width           =   6.28e+2   Begin Listbox lstSetMovies      AutoDeactivate  =   True      AutoHideScrollbars=   True      Bold            =   ""      Border          =   True      ColumnCount     =   3      ColumnsResizable=   ""      ColumnWidths    =   "80%,0%,20%"      DataField       =   ""      DataSource      =   ""      DefaultRowHeight=   22      Enabled         =   True      EnableDrag      =   True      EnableDragReorder=   ""      GridLinesHorizontal=   0      GridLinesVertical=   0      HasHeading      =   False      HeadingIndex    =   -1      Height          =   452      HelpTag         =   ""      Hierarchical    =   False      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   ""      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   True      LockTop         =   True      RequiresSelection=   ""      Scope           =   0      ScrollbarHorizontal=   ""      ScrollBarVertical=   True      SelectionType   =   0      TabIndex        =   0      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   12      TextUnit        =   0      Top             =   14      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   331      _ScrollWidth    =   -1   End   Begin Listbox lstSets      AutoDeactivate  =   True      AutoHideScrollbars=   True      Bold            =   ""      Border          =   True      ColumnCount     =   3      ColumnsResizable=   ""      ColumnWidths    =   "90%, 10%, 0"      DataField       =   ""      DataSource      =   ""      DefaultRowHeight=   22      Enabled         =   True      EnableDrag      =   False      EnableDragReorder=   True      GridLinesHorizontal=   0      GridLinesVertical=   0      HasHeading      =   False      HeadingIndex    =   -1      Height          =   452      HelpTag         =   ""      Hierarchical    =   True      Index           =   -2147483648      InitialParent   =   ""      InitialValue    =   ""      Italic          =   ""      Left            =   363      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   True      RequiresSelection=   ""      Scope           =   0      ScrollbarHorizontal=   ""      ScrollBarVertical=   True      SelectionType   =   0      TabIndex        =   1      TabPanelIndex   =   0      TabStop         =   True      TextFont        =   "System"      TextSize        =   12      TextUnit        =   0      Top             =   14      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   245      _ScrollWidth    =   -1   End   Begin AddRemoveButtons arSet      AcceptFocus     =   ""      AcceptTabs      =   ""      AutoDeactivate  =   True      Backdrop        =   ""      DoubleBuffer    =   False      Enabled         =   True      EraseBackground =   False      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   363      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   False      Scope           =   0      TabIndex        =   2      TabPanelIndex   =   0      TabStop         =   True      Top             =   478      UseFocusRing    =   True      Visible         =   True      Width           =   45   End   Begin SuperTextfield txtSet      AcceptTabs      =   ""      Alignment       =   0      AutoComplete    =   ""      AutoDeactivate  =   True      AutomaticallyCheckSpelling=   False      BackColor       =   &hFFFFFF      Bold            =   ""      Border          =   True      CueText         =   "Set Name"      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Format          =   ""      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      Italic          =   ""      Left            =   420      LimitText       =   0      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   False      Mask            =   ""      Password        =   ""      ReadOnly        =   ""      Scope           =   0      TabIndex        =   3      TabPanelIndex   =   0      TabStop         =   True      Text            =   ""      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   0      TextUnit        =   0      Top             =   478      Underline       =   ""      UseFocusRing    =   True      Visible         =   True      Width           =   188   End   Begin Label lblArray      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   False      Height          =   22      HelpTag         =   ""      Index           =   0      InitialParent   =   ""      Italic          =   ""      Left            =   20      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   True      LockRight       =   ""      LockTop         =   False      Multiline       =   ""      Scope           =   0      Selectable      =   False      TabIndex        =   4      TabPanelIndex   =   0      Text            =   "Drag && Drop Movies onto a set to add them."      TextAlign       =   0      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   11      TextUnit        =   0      Top             =   478      Transparent     =   False      Underline       =   ""      Visible         =   True      Width           =   276   End   Begin Label lblOrder      AutoDeactivate  =   True      Bold            =   ""      DataField       =   ""      DataSource      =   ""      Enabled         =   True      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Italic          =   ""      Left            =   308      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   False      Multiline       =   ""      Scope           =   0      Selectable      =   False      TabIndex        =   6      TabPanelIndex   =   0      Text            =   "##"      TextAlign       =   2      TextColor       =   &h000000      TextFont        =   "System"      TextSize        =   11      TextUnit        =   0      Top             =   478      Transparent     =   False      Underline       =   ""      Visible         =   False      Width           =   22   End   Begin UpDownArrows udOrder      AcceptFocus     =   False      AutoDeactivate  =   True      Enabled         =   True      Height          =   22      HelpTag         =   ""      Index           =   -2147483648      InitialParent   =   ""      Left            =   338      LockBottom      =   True      LockedInPosition=   False      LockLeft        =   False      LockRight       =   True      LockTop         =   False      Scope           =   0      TabIndex        =   5      TabPanelIndex   =   0      TabStop         =   True      Top             =   478      Visible         =   False      Width           =   13   EndEnd#tag EndWindow#tag WindowCode	#tag Event		Sub Close()		  Preferences.SaveWindowPos( self, "wndSetManager" )		  Close		  		  		  wndMain.CommonActions( "ReloadList" )		End Sub	#tag EndEvent	#tag Event		Sub Open()		  Preferences.LoadWindowPos( self, "wndSetManager" )		  		  Dim icns as new IconMBS( "fold", "MACS" )		  FolderIcon = icns.IconFamily.Small32BitData		  FolderIcon.Mask = icns.IconFamily.Small8BitMask		  		  RefreshSetMovieList		End Sub	#tag EndEvent	#tag MenuHandler		Function FileCloseWindow() As Boolean Handles FileCloseWindow.Action			Close			Return True					End Function	#tag EndMenuHandler	#tag Method, Flags = &h1		Protected Sub AddSet(f as FolderItem, SetName as String, SetOrder as Integer)		  If f = Nil Then f = GetFolderItem( lstSetMovies.Cell( lstSetMovies.ListIndex, 1 ) )		  If f <> Nil and f.Exists Then MovieAttr.NFORead( f )		  		  MovieAttr.Set = SetName		  MovieAttr.SetOrder = SetOrder		  		  MovieAttr.NFOWrite( FindNFOFile( f ) )		  		  For i as Integer = 0 to lstSetMovies.ListCount - 1		    If f.AbsolutePath = lstSetMovies.Cell( i, 1 ) Then lstSetMovies.Cell( i, 2 ) = SetName + "ï£¿" + str( SetOrder )		  Next		  		  RefreshSetsList		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub AllExpanded(Value as Boolean)		  Dim CurrentRow as integer = 0		  		  While CurrentRow < lstSets.ListCount		    lstSets.Expanded(CurrentRow) = False		    CurrentRow = CurrentRow + 1		  Wend		End Sub	#tag EndMethod	#tag Method, Flags = &h1		Protected Sub DelSet(f as FolderItem, Refresh as Boolean = False)		  If f = Nil Then f = GetFolderItem( lstSetMovies.Cell( lstSetMovies.ListIndex, 1 ) )		  If f <> Nil and f.Exists Then MovieAttr.NFORead( f )		  		  MovieAttr.Set = ""		  MovieAttr.SetOrder = -1		  		  MovieAttr.NFOWrite( FindNFOFile( f ) )		  		  If Refresh Then RefreshSetsList		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub RefreshSetMovieList()		  lstSetMovies.DeleteAllRows		  		  Dim lstbox as Listbox = wndMain.lstMovies		  For i as Integer = 0 to lstbox.ListCount - 1		    If lstbox.Cell( i, 2 ) <> "" Then		      lstSetMovies.AddRow lstbox.Cell( i, 0 ), lstbox.Cell( i, 1 ), lstbox.Cell( i, 9 )		      lstSetMovies.RowPicture( lstSetMovies.LastIndex ) = miniconmovie		    End If		  Next		  		  RefreshSetsList		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub RefreshSetsList()		  Dim lastindex as Integer = lstSets.ListIndex		  Dim LastSelection as String = lstSets.Cell( lstSets.ListIndex, 2 )		  		  lstSets.DeleteAllRows		  		  Dim Sets() as String		  Dim i as Integer		  		  For i = 0 to lstSetMovies.ListCount - 1		    If lstSetMovies.Cell( i, 2 ) <> "" Then Sets.Append lstSetMovies.Cell( i, 2 ).NthField( "ï£¿", 1 )		  Next		  		  Sets.Sort		  		  For i = Sets.Ubound to 1 Step - 1		    If Sets(i) = Sets(i-1) Then Sets.Remove(i)		  Next i		  		  'If SetsExpanded.Ubound <= -1 Then SetsExpanded = Sets		  SetsExpanded = Sets		  		  For i = 0 to Sets.Ubound		    lstSets.AddFolder Sets(i)		    lstSets.RowTag( lstSets.LastIndex )      = "Folder"		    lstSets.CellBold( lstSets.LastIndex, 0 ) = True		    lstSets.RowPicture( lstSets.LastIndex )  = FolderIcon		    'lstSets.CellType( lstSets.LastIndex, 0 ) = lstSets.TypeEditableTextField		    'lstSets.Expanded( lstSets.LastIndex )    = True		    lstSets.Expanded( lstSets.LastIndex ) = ( Sets(i) = SetsExpanded(i) )		  Next		  		  lstSets.SortedColumn = 1		  lstSets.Sort		  		  'If lastindex < lstSets.ListCount Then lstSets.ListIndex = lastindex Else lstSets.ListIndex = lstSets.LastIndex		  For i = 0 to lstSets.ListCount - 1		    If lstSets.Cell( i, 2 ) = LastSelection Then lstSets.ListIndex = i		  Next		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub UpdateSetOrder(Change as Integer)		  Dim f as FolderItem = GetFolderItem( lstSets.Cell( lstSets.ListIndex, 2 ) )		  If f <> Nil and f.Exists Then MovieAttr.NFORead( f ) Else Return		  		  Dim i as Integer = Val( lblOrder.Text )		  If Change = -1 And Val( lblOrder.Text ) > 0 Then		    MovieAttr.SetOrder = i + Change		  ElseIf Change = 1 Then		    MovieAttr.SetOrder = i + Change		  Else		    MovieAttr.SetOrder = 0		  End If		  		  MovieAttr.NFOWrite( FindNFOFile( f ) )		  		  For n as Integer = 0 to lstSetMovies.ListCount - 1		    If lstSetMovies.Cell( n, 1 ) = lstSets.Cell( lstSets.ListIndex, 2 ) Then		      Dim Original as String = lstSetMovies.Cell( n, 2 ).NthField( "ï£¿", 1 )		      lstSetMovies.Cell( n, 2 ) = Original + "ï£¿" + str( MovieAttr.SetOrder )		    End If		  Next		  		  RefreshSetsList		End Sub	#tag EndMethod	#tag Property, Flags = &h0		ColEx As Boolean	#tag EndProperty	#tag Property, Flags = &h0		FolderIcon As Picture	#tag EndProperty	#tag Property, Flags = &h0		NextFolderIndex As Integer	#tag EndProperty	#tag Property, Flags = &h0		ParentFolderIndex As Integer	#tag EndProperty	#tag Property, Flags = &h0		SetsExpanded() As String	#tag EndProperty	#tag Constant, Name = kDragandDrop, Type = String, Dynamic = True, Default = \"Drag && Drop Movies onto a set to add them.", Scope = Public		#Tag Instance, Platform = Any, Language = en, Definition  = \"Drag && Drop Movies onto a set to add them."		#Tag Instance, Platform = Any, Language = nl, Definition  = \"Draag een film over een set om deze toe te voegen."	#tag EndConstant#tag EndWindowCode#tag Events lstSetMovies	#tag Event		Function DragRow(drag As DragItem, row As Integer) As Boolean		  'drag.Text = Me.Cell( row, 0 )		  drag.Text = Me.List( row )		  drag.DragPicture = miniconmovie		  Return True		End Function	#tag EndEvent	#tag Event		Sub Open()		  #If NOT DebugBuild Then Me.ColumnWidths = "100%, 0, 0"		End Sub	#tag EndEvent	#tag Event		Function MouseDown(x As Integer, y As Integer) As Boolean		  		  If IsContextualClick Then		    		    		  End If		End Function	#tag EndEvent#tag EndEvents#tag Events lstSets	#tag Event		Sub ExpandRow(row As Integer)		  For i as Integer = 0 to lstSetMovies.ListCount - 1		    If lstSetMovies.Cell(i, 2).NthField( "ï£¿", 1 ) = Me.Cell( row, 0 ) Then		      Me.AddRow lstSetMovies.Cell( i, 0 ), lstSetMovies.Cell( i, 2 ).NthField( "ï£¿", 2 ), lstSetMovies.Cell( i, 1 )		      Me.RowPicture( Me.LastIndex ) = miniconmovie		    End If		  Next		  		  If Keyboard.AsyncAltKey And NOT ColEx Then		    ColEx = True // Prevent StackOverflowException		    For i as Integer = 0 to Me.ListCount - 1		      If Me.RowTag(i) = "Folder" Then Me.Expanded(i) = True		    Next		    ColEx = False		  End If		  		  		  // Save expanded state of folders		  Dim n as Integer = -1		  For i as Integer = 0 to Me.ListCount - 1		    If Me.RowTag(i) = "Folder" then		      n = n + 1		      If SetsExpanded.Ubound >= n and row = i Then SetsExpanded(n) = Me.Cell(i,0)		    End If		  Next		End Sub	#tag EndEvent	#tag Event		Sub Change()		  arSet.RemoveEnabled = Me.ListIndex > -1 '( Me.ListIndex > -1 And lstSets.RowTag( lstSets.ListIndex ) <> "Folder" )		  		  'If Me.RowTag( Me.ListIndex ) = "Folder" Then OldSetName = Me.Cell( Me.ListIndex, 0 ) Else OldSetName = ""		  		  If Me.ListIndex > -1 And Me.RowTag( Me.ListIndex ) <> "Folder" Then		    lblOrder.Visible = True		    udOrder.Visible = True		    		    lblOrder.Text = Me.Cell( Me.ListIndex, 1 )		  Else		    lblOrder.Visible = False		    udOrder.Visible = False		  End If		End Sub	#tag EndEvent	#tag Event		Sub Open()		  me.AcceptTextDrop		  #If NOT DebugBuild Then Me.ColumnWidths = "100%, 0, 0"		End Sub	#tag EndEvent	#tag Event		Sub DropObject(obj As DragItem, action As Integer)		  If obj.TextAvailable Then		    		    Dim order as Integer		    		    		    For i as Integer = 0 to ParentFolderIndex		      If lstSets.RowTag( i ) = "Folder" Then order = NextFolderIndex - ParentFolderIndex		    Next		    If order <= 0 Then order = lstSets.ListCount - ParentFolderIndex		    'AddSet ParentFolderIndex, order		    		    AddSet Nil, lstSets.Cell( ParentFolderIndex, 0 ), order		  End If		  MouseCursor = System.Cursors.StandardPointer		End Sub	#tag EndEvent	#tag Event		Function DragOver(x As Integer, y As Integer, obj As DragItem, action As Integer) As Boolean		  If NOT obj.TextAvailable Or obj.Text = "RemoveItem" Then Return False		  		  me.SetFocus		  		  Dim HoverIndex as Integer		  If Y >= -1 and Floor( ( Y / Me.RowHeight ) + me.ScrollPosition ) <= Me.ListCount -1 Then		    		    MouseCursor = System.Cursors.Copy		    		    For i as Integer = 0 to Floor( ( Y / Me.RowHeight ) + me.ScrollPosition )		      If Me.RowTag( i ) = "Folder" Then ParentFolderIndex = i		    Next		    		    For i as Integer = Me.ListCount - 1 DownTo ParentFolderIndex + 1		      If Me.RowTag( i ) = "Folder" Then NextFolderIndex = i		    Next		    		    // Save expanded state of folders		    Dim n as Integer = -1		    For i as Integer = 0 to lstSets.ListCount - 1		      If lstSets.RowTag(i) = "Folder" then		        n = n + 1		        If lstSets.Cell( ParentFolderIndex, 0 ) = lstSets.Cell(i,0) Then lstSets.Expanded(i) = True		      End If		    Next		    		    Me.ListIndex = ParentFolderIndex		  Else // Out of bounds		    Me.ListIndex = -1		    MouseCursor = System.Cursors.StandardPointer		  End If		  		  Refresh		End Function	#tag EndEvent	#tag Event		Sub DragExit(obj As DragItem, action As Integer)		  Me.ListIndex = -1		  Me.Refresh		  MouseCursor = System.Cursors.StandardPointer		End Sub	#tag EndEvent	#tag Event		Function DragRow(drag As DragItem, row As Integer) As Boolean		  drag.Text = "RemoveItem"		  Return True		End Function	#tag EndEvent	#tag Event		Function KeyDown(Key As String) As Boolean		  If Keyboard.AsyncCommandKey And Keyboard.AsyncKeyDown(&h33) Then arSet.PushRemove		End Function	#tag EndEvent	#tag Event		Function DragReorderRows(newPosition as Integer, parentRow as Integer) As Boolean		  Self.Title = "CurIndex: " + str( me.ListIndex ) + " | NewPos: " + str( newPosition ) + " | parent: " + str( parentRow )		  		  		End Function	#tag EndEvent	#tag Event		Sub CollapseRow(row As Integer)		  Dim n as Integer = -1		  		  If Keyboard.AsyncAltKey And NOT ColEx Then		    ColEx = True		    For i as Integer = me.ListCount - 1 DownTo 0		      If Me.RowTag(i) = "Folder" Then Me.Expanded(i) = False		    Next		    ColEx = False		  End If		  		  // Save colapsed state of folders		  For i as Integer = 0 to Me.ListCount - 1		    If Me.RowTag(i) = "Folder" then		      n = n + 1		      If SetsExpanded.Ubound >= n and row = i Then SetsExpanded(n) = "--"		    End If		  Next		End Sub	#tag EndEvent	#tag Event		Sub CellTextChange(row as Integer, column as Integer)		  'Dim n, o as Integer = 0		  'For i as Integer = Me.ListCount - 1 DownTo row + 1		  'If Me.RowTag(i) = "Folder" Then n = i		  'Next		  '		  'For i as Integer = Me.ListIndex + 1 to n		  'o = o + 1		  ''If Me.RowTag(i) <> "Folder" Then		  'AddSet( GetFolderItem( Me.Cell(i, 2) ), Me.Cell( Me.ListIndex, 0 ), o )		  ''End If		  'Next		End Sub	#tag EndEvent#tag EndEvents#tag Events arSet	#tag Event		Sub ActionAdd()		  If Trim( txtSet.Text ) = "" Then Return		  Dim b as Boolean = False		  		  For i as Integer = 0 to lstSets.ListCount - 1		    If lstSets.RowTag(i) = "Folder" and lstSets.Cell( i, 0 ) = Trim( txtSet.Text ) Then b = True		  Next		  		  If b Then Return		  		  lstSets.AddFolder( Trim( txtSet.Text ) )		  lstSets.RowTag(     lstSets.LastIndex ) = "Folder"		  lstSets.RowPicture( lstSets.LastIndex )   = FolderIcon		  lstSets.CellBold(   lstSets.LastIndex, 0 ) = True		  lstSets.Expanded(   lstSets.LastIndex ) = True		  'lstSets.CellType(  lstSets.LastIndex, 0) = lstSets.TypeEditable		  		  Dim n as Integer = 0		  		  For i as Integer = 0 to lstSetMovies.ListCount - 1		    If lstSetMovies.Cell(i, 0).Lowercase.InStr( 0, txtSet.Text.Lowercase ) > 0 Then		      n = n + 1		      AddSet( GetFolderItem( lstSetMovies.Cell( i, 1 ) ), txtSet.Text, n )		    End If		  Next		  		  txtSet.Text = ""		  		  lstSets.SortedColumn = 0		  lstSets.Sort		End Sub	#tag EndEvent	#tag Event		Sub ActionRemove()		  If lstSets.RowTag( lstSets.ListIndex ) = "Folder" Then		    		    For i as Integer = 0 to lstSetMovies.ListCount - 1		      If lstSetMovies.Cell( i, 2 ).NthField( "ï£¿", 1 ) = lstSets.Cell( lstSets.ListIndex, 0 ) Then		        DelSet GetFolderItem( lstSetMovies.Cell( i, 1 ) )		        		        lstSetMovies.Cell( i, 2 ) = ""		      End If		    Next		    		  Else		    		    For i as Integer = 0 to lstSetMovies.ListCount - 1		      If lstSets.Cell( lstSets.ListIndex, 0 ) = lstSetMovies.Cell( i, 0 ) Then		        DelSet GetFolderItem( lstSetMovies.Cell( i, 1 ) )		        lstSetMovies.Cell( i, 2 ) = ""		      End If		    Next		    		  End If		  		  RefreshSetsList		End Sub	#tag EndEvent	#tag Event		Sub Open()		  me.AddEnabled = False		End Sub	#tag EndEvent#tag EndEvents#tag Events txtSet	#tag Event		Function KeyDown(Key as String) As Boolean		  If Keyboard.AsyncKeyDown( &h4C ) or Keyboard.AsyncKeyDown( &h24 ) then		    If Me.Active and Me.Text <> "" then arSet.PushAdd		    Me.Text = ""		  End If		End Function	#tag EndEvent	#tag Event		Sub TextChange()		  'arSet.AddEnabled = Len( Me.Text ) > 0		  arSet.AddEnabled = False		  arSet.Refresh		End Sub	#tag EndEvent#tag EndEvents#tag Events udOrder	#tag Event		Sub Up()		  UpdateSetOrder( 1 )		End Sub	#tag EndEvent	#tag Event		Sub Down()		  UpdateSetOrder( -1 )		End Sub	#tag EndEvent#tag EndEvents