#tag ClassProtected Class TMDBInherits HTTPSocket	#tag Event		Sub Error(code as integer)		  SocketError( code, Me )		  		Exception err as NilObjectException		  Me.Close		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub SearchResults(XmlContent as String, MovieName as String)		  Dim Xml as new XmlDocument		  Dim xroot as XmlNode		  		  Xml.PreserveWhitespace = False		  Xml.LoadXml( XmlContent )		  xroot = Xml.Child(0).Child(2)		  		  If Scrape.Cancelled then Return		  		  // 2+ movies found.		  If xroot.ChildCount > 1 then		    ShowSearchWindow( Xml )		    		    // No movies found during manual search		  ElseIf xroot.FirstChild.Value = "Nothing Found." and Scrape.ManualSearch then		    MsgBox Scrape.kNoMoviesFoundTryAgain		    		    // No movies found during regular search		  ElseIf xroot.FirstChild.Value = "Nothing Found." and NOT Scrape.ManualSearch then		    		    If dlgWindow( Scrape.kNoMoviesFound, Scrape.kManualSearchMovie ) then		      If MovieName <> "" then		        wndSearchMovie.edtSearch.Text = MovieName		      Else		        If wndMain.ppMain.Value = 0 then wndSearchMovie.edtSearch.Text = wndMain.lstMovies.Cell( wndMain.lstMovies.ListIndex, 0 ).ReplaceAll( ".", " " )		      End If		    End If		    		    // Regular search		  ElseIf xroot.ChildCount > 0 and Scrape.ManualSearch then		    ShowSearchWindow( Xml )		    		    // Only 1 result		  ElseIf xroot.ChildCount = 1 and NOT Scrape.ManualSearch then		    Dim xnode, xitem as XmlNode		    For i as Integer = 0 to xroot.ChildCount - 1		      xnode = xroot.Child(i)		      If xnode.FirstChild <> Nil then		        For n as Integer = 0 to xnode.ChildCount - 1		          xitem = xnode.Child(n)		          If xitem.FirstChild <> Nil and xitem.Name = "id" then Scrape.TMDBApi( xitem.FirstChild.Value )		        Next		      End If		    Next		    		  End If		  		  Return		End Sub	#tag EndMethod	#tag Method, Flags = &h1		Protected Sub ShowSearchWindow(Xml as XmlDocument)		  Dim xroot, xnode, xitem, xleaf as XmlNode		  Dim lstbox as Listbox		  Dim sTitle, sYear as String		  		  xroot = Xml.Child(0).Child(2)		  		  If Scrape.Cancelled then Return		  Progress("close")		  wndSearchMovie.Show		  lstbox = wndSearchMovie.lstMovies		  lstbox.DeleteAllRows		  		  Dim c as new Clipboard		  c.Text = Xml.ToString		  		  For i as Integer = 0 to xroot.ChildCount - 1		    xnode = xroot.Child(i)		    If xnode.FirstChild <> Nil then		      lstbox.AddRow		      		      For n as Integer = 0 to xnode.ChildCount - 1		        xitem = xnode.Child(n)		        		        If xitem.FirstChild <> Nil then		          		          Select Case xitem.Name		            		          Case "name"		            lstbox.Cell( lstbox.LastIndex, 2 ) = xitem.FirstChild.Value		            sTitle = xitem.FirstChild.Value		            		          case "id"		            lstbox.Cell( lstbox.LastIndex, 1 ) = xitem.FirstChild.Value		            		          case "released"		            lstbox.Cell( lstbox.LastIndex, 3 ) = xitem.FirstChild.Value		            sYear = xitem.FirstChild.Value.Left(4)		            		          case "overview"		            lstbox.Cell( lstbox.LastIndex, 4 ) = xitem.FirstChild.Value		            		          case "images"		            For t as Integer = 0 to xitem.ChildCount - 1		              xleaf = xitem.Child(t)		              		              If xleaf.GetAttribute("type") = "poster" and xleaf.GetAttribute("size") = "w154" then _		              lstbox.Cell( lstbox.LastIndex, 5 ) = xleaf.GetAttribute("url")		              If xleaf.GetAttribute("type") = "backdrop" and xleaf.GetAttribute("size") = "thumb" then _		              lstbox.Cell( lstbox.LastIndex, 6 ) = xleaf.GetAttribute("url")		              		              		            Next // @END xitem.ChildCount		            		          End Select		          		          lstbox.Cell( lstbox.LastIndex, 0 ) = sTitle + " (" + sYear + ")"		          		        End If // @END xitem <> Nil		        		      Next // @END xnode.ChildCount		      		    End IF // @END xnode <> Nil		    		  Next // @END xroot.ChildCount		  		  lstbox.SortedColumn = 3		  lstbox.ColumnSortDirection(3) = 2		  lstbox.Sort		  lstbox.ListIndex = 0		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Function URL_Images(ID as String) As String		  Return "http://api.themoviedb.org/2.1/Movie.getImages/" + Prefs.textStringForKey("DBLanguage") + "/xml/" + ApiKey + "/" + ID		End Function	#tag EndMethod	#tag Method, Flags = &h0		Function URL_Info(ID as String) As String		  If ID.Left(2) = "tt" then		    // IMDB Lookup		    Return "http://api.themoviedb.org/2.1/Movie.imdbLookup/" + Prefs.textStringForKey("DBLanguage") + "/xml/" + ApiKey + "/" + ID		  Else		    // TMDB Lookup		    Return "http://api.themoviedb.org/2.1/Movie.getInfo/" + Prefs.textStringForKey("DBLanguage") + "/xml/" + ApiKey + "/" + ID		  End If		End Function	#tag EndMethod	#tag Method, Flags = &h0		Function URL_Search(MovieName as String) As String		  Return "http://api.themoviedb.org/2.1/Movie.search/" + Prefs.textStringForKey("DBLanguage") + "/xml/" + ApiKey + "/" + String2Entities( MovieName )		End Function	#tag EndMethod	#tag Note, Name = TMDB Api Docs				http://api.themoviedb.org/2.1	#tag EndNote	#tag Constant, Name = ApiKey, Type = String, Dynamic = False, Default = \"683359f622e4e27f41832a019d90b002", Scope = Public	#tag EndConstant	#tag Constant, Name = MirrorPath, Type = String, Dynamic = False, Default = \"http://hwcdn.themoviedb.org", Scope = Public	#tag EndConstant	#tag ViewBehavior		#tag ViewProperty			Name="Address"			Visible=true			Group="Behavior"			Type="String"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="defaultPort"			Group="Behavior"			InitialValue="0"			Type="integer"			InheritedFrom="HTTPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="httpProxyAddress"			Group="Behavior"			Type="string"			EditorType="MultiLineEditor"			InheritedFrom="HTTPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="httpProxyPort"			Group="Behavior"			InitialValue="0"			Type="integer"			InheritedFrom="HTTPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Index"			Visible=true			Group="ID"			Type="Integer"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Left"			Visible=true			Group="Position"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Name"			Visible=true			Group="ID"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Port"			Visible=true			Group="Behavior"			InitialValue="0"			Type="Integer"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Super"			Visible=true			Group="ID"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="Top"			Visible=true			Group="Position"			InheritedFrom="TCPSocket"		#tag EndViewProperty		#tag ViewProperty			Name="yield"			Group="Behavior"			InitialValue="0"			Type="boolean"			InheritedFrom="HTTPSocket"		#tag EndViewProperty	#tag EndViewBehaviorEnd Class#tag EndClass